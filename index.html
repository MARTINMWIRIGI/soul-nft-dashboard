<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoulInternet — NFT Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
body { margin:0; font-family:Inter, Arial; color:#eaf2ff;
  background: url('./soul.jpg') center/cover no-repeat fixed; position:relative; min-height:100vh; }
body::after { content:''; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:0; }
.container { position:relative; z-index:1; max-width:1100px; margin:0 auto; padding:20px; }
.header { display:flex; align-items:center; gap:12px; padding:12px 0; }
.nav-right { margin-left:auto; display:flex; gap:8px; align-items:center; }
.button { background:linear-gradient(90deg,#00e6d9,#7c3aed); color:#00121a; padding:8px 12px; border-radius:999px; font-weight:700; border:none; cursor:pointer; }
.card { background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.006)); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:16px; }
.grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); }
footer { padding:12px; text-align:center; color:rgba(230,240,255,0.6); }
.input { padding:8px; border-radius:8px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); color: #eaf2ff; width:100%; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div style="font-weight:800">SoulInternet</div>
    <nav style="margin-left:18px"><a href="#vaults">Vaults</a> &nbsp; <a href="#mint">Mint</a></nav>
    <div class="nav-right">
      <div id="netName">Not connected</div>
      <button id="connectBtn" class="button">Connect Wallet</button>
    </div>
  </div>

  <section id="vaults">
    <h2>Vaults</h2>
    <p>Choose a vault to mint your MultiSoul</p>
    <div id="vaultGrid" class="grid"></div>
  </section>

  <section id="mint" style="margin-top:18px;">
    <h2>Mint</h2>
    <div class="card">
      <div style="display:flex; gap:12px;">
        <div style="flex:1">
          <input id="metaUri" placeholder="ipfs://..." class="input"/>
          <div style="margin-top:8px;">
            <button id="chooseFile" class="button">Choose file to upload</button>
            <input id="fileInput" type="file" style="display:none" accept="image/*,audio/*,video/*"/>
          </div>
        </div>
        <div style="width:220px">
          <select id="vaultSelect" class="input"></select>
          <input id="priceInput" placeholder="Price MATIC" class="input" style="margin-top:8px;"/>
        </div>
      </div>
      <div style="margin-top:12px;">
        <button id="mintBtn" class="button">Mint NFT</button>
        <span id="mintStatus" style="margin-left:12px">Ready</span>
      </div>
    </div>
    <div id="recentGrid" class="grid" style="margin-top:12px;"></div>
  </section>

  <footer>© 2025 SoulInternet</footer>
</div>

<script>
const VAULTS = [
  {key:"CULTURE_LANG", title:"Cultural & Linguistic Vault"},
  {key:"SMART_CARBON", title:"Smart Carbon Credits Vault"},
  {key:"REFUGEE_ID", title:"Refugee Identity Vault"},
  {key:"COSMIC_TIME", title:"Cosmic & Time Capsule Vault"},
  {key:"DONOR_FUND", title:"Donor Fund Vault"}
];

const CONFIG_DEFAULT = { CONTRACT_ADDRESS: "0x4df55fad5af6ce9238d5d43f1589bc52cbea7b82", CONTRIBUTOR: "0x8Cbe46A175E9CE3bB9FCF1F739F8C6b37d3308b3", UPLOAD_API: "/api/upload" };
let CONFIG = CONFIG_DEFAULT;

async function loadConfig(){
  try{
    const r = await fetch('/config.json');
    if(r.ok) CONFIG = await r.json();
  }catch(e){}
}
loadConfig();

const ABI = [
  "function getQuotaInfo(bytes32) view returns (uint256,uint256,uint256,uint256,bool)",
  "function publicMintEnabled(bytes32) view returns (bool)",
  "function mintPublic(address, bytes32, string) payable returns (uint256)",
  "event Minted(address indexed buyer,uint256 indexed tokenId,bytes32 tag,string uri,uint256 price)"
];

let provider, signer, contract, userAddress;
function $(s){return document.querySelector(s);}

function buildUI(){
  const grid = $('#vaultGrid');
  grid.innerHTML = '';
  VAULTS.forEach(v=>{
    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `<div style="font-weight:700">${v.title}</div><div style="margin-top:8px"><button onclick="openMint('${v.key}')" class="button">Mint</button></div>`;
    grid.appendChild(el);
    const opt = document.createElement('option'); opt.value=v.key; opt.textContent=v.title; $('#vaultSelect').appendChild(opt);
  });
}
buildUI();

$('#connectBtn').addEventListener('click', async ()=>{
  if(window.ethereum){
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts',[]);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(CONFIG.CONTRACT_ADDRESS, ABI, signer);
    $('#netName').textContent = 'Connected: ' + userAddress.slice(0,6) + '...' + userAddress.slice(-4);
    await refreshAllQuotas();
  } else alert('Install MetaMask');
});

async function refreshAllQuotas(){
  if(!contract) return;
  for(const v of VAULTS){
    try{
      const tag = ethers.utils.formatBytes32String(v.key);
      const info = await contract.getQuotaInfo(tag);
      // show floor
    }catch(e){}
  }
}

function openMint(key){
  $('#vaultSelect').value = key;
  location.hash = '#mint';
}

$('#chooseFile').addEventListener('click', ()=> $('#fileInput').click());
$('#fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  $('#mintStatus').textContent = 'Uploading...';
  try{
    const uri = await uploadFile(f);
    $('#metaUri').value = uri;
    $('#mintStatus').textContent = 'Uploaded';
  }catch(e){ $('#mintStatus').textContent = 'Upload failed'; alert(e.message); }
});

async function uploadFile(file){
  const proxy = CONFIG.UPLOAD_API || '/api/upload';
  const res = await fetch(proxy, { method:'POST', body:file });
  if(!res.ok) throw new Error('Upload failed');
  const j = await res.json();
  if(!j?.value?.cid) throw new Error('No CID');
  return 'ipfs://' + j.value.cid;
}

$('#mintBtn').addEventListener('click', async ()=>{
  if(!contract) return alert('Connect wallet first');
  const meta = $('#metaUri').value.trim();
  if(!meta) return alert('Provide metadata ipfs:// URI');
  const vault = $('#vaultSelect').value;
  const price = $('#priceInput').value || '0.01';
  const value = ethers.utils.parseEther(price.toString());
  try{
    $('#mintStatus').textContent = 'Sending tx...';
    const tx = await contract.mintPublic(CONFIG.CONTRIBUTOR, ethers.utils.formatBytes32String(vault), meta, { value });
    await tx.wait();
    $('#mintStatus').textContent = 'Minted!';
    alert('Mint success');
  }catch(e){ $('#mintStatus').textContent='Failed'; alert(e.message || e); }
});
</script>
</body>
</html>
