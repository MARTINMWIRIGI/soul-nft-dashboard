<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cultural & Linguistic Vault</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@nftstorage/nft-storage/dist/bundle.esm.min.js" type="module"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fdfdfd;
      margin: 0;
      padding: 0;
      color: #222;
    }
    header {
      background: #1a1a1a;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    h1 { font-size: 1.6rem; margin: 0; }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .card h2 {
      font-size: 1.2rem;
      margin-bottom: .5rem;
      text-align: center;
    }
    .card button, .card input {
      margin-top: .5rem;
      padding: .6rem 1rem;
      border: none;
      border-radius: 8px;
      background: #0077ff;
      color: #fff;
      cursor: pointer;
      font-size: .9rem;
    }
    .card button:hover { background: #005fcc; }
    video, audio {
      max-width: 100%;
      border-radius: 8px;
      margin-top: .5rem;
    }
    footer {
      text-align: center;
      padding: 1rem;
      font-size: .8rem;
      background: #f1f1f1;
    }
    /* Mobile adjustments */
    @media (max-width: 600px) {
      h1 { font-size: 1.3rem; }
      .card h2 { font-size: 1rem; }
      .card button { font-size: .8rem; padding: .5rem .8rem; }
    }
  </style>
</head>
<body>

<header class="header" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#111;position:relative;">
  <div class="logo" style="display:flex;align-items:center;gap:8px;font-weight:bold;color:white;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <rect x="3" y="3" width="7" height="7" fill="white"/>
      <rect x="14" y="3" width="7" height="7" fill="white"/>
      <rect x="3" y="14" width="7" height="7" fill="white"/>
      <rect x="14" y="14" width="7" height="7" fill="white"/>
    </svg>
    <span style="font-weight:bold;font-size:18px;color:white;">Soul Internet</span>
  </div>

  <!-- Navigation links (desktop) -->
  

  <div class="header-right" style="display:flex;align-items:center;gap:12px;">
    <!-- Wallet Button -->
    <button onclick="connectWallet()" id="walletBtn" 
      style="background:#4CAF50;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">
      Connect Wallet
    </button>

    <!-- Hamburger -->
    <button class="menu-btn" onclick="toggleMenu()" style="background:none;border:none;cursor:pointer;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M3 12h18M3 6h18M3 18h18" stroke="white" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>
</header>

<!-- Mobile Dropdown -->
<div id="mobileMenu" style="display:none;flex-direction:column;position:absolute;top:60px;right:16px;background:white;padding:16px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.2);z-index:1000;">
  <a href="/" style="color:blue;font-weight:bold;text-decoration:none;margin:8px 0;">Home</a>
  <a href="/cultural-vault.html" style="color:blue;font-weight:bold;text-decoration:none;margin:8px 0;">Cultural Vault</a>
  <button onclick="connectWallet()" id="walletBtnMobile" 
    style="background:#4CAF50;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;margin-top:10px;">
    Connect Wallet
  </button>
</div>

<script>
function toggleMenu() {
  const menu = document.getElementById("mobileMenu");
  menu.style.display = (menu.style.display === "flex") ? "none" : "flex";
}

// MetaMask connect
async function connectWallet() {
  if (typeof window.ethereum !== "undefined") {
    try {
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      const shortAddress = accounts[0].slice(0,6) + "..." + accounts[0].slice(-4);

      // Update both desktop and mobile buttons
      const walletBtn = document.getElementById("walletBtn");
      const walletBtnMobile = document.getElementById("walletBtnMobile");
      if (walletBtn) {
        walletBtn.innerText = "Connected: " + shortAddress;
        walletBtn.style.background = "#2E7D32";
      }
      if (walletBtnMobile) {
        walletBtnMobile.innerText = "Connected: " + shortAddress;
        walletBtnMobile.style.background = "#2E7D32";
      }
    } catch (err) {
      alert("Connection failed: " + err.message);
    }
  } else {
    alert("MetaMask not detected. Please install MetaMask.");
  }
}
</script>
  
  
  <header>
    <h1>Cultural & Linguistic Vault</h1>
    <p>Preserve languages, traditions, and heritage on-chain</p>
  </header>

  <div class="container">
    <!-- Facial Recognition -->

<!-- Facial Recognition -->
<div class="card" style="padding:20px; text-align:center;">
  <h2 style="margin-bottom:10px;">üåç Facial Recognition Layer</h2>
  <p style="font-size:14px; color:#555; margin-bottom:15px;">
    Capture cultural expressions and preserve them immutably on-chain.
  </p>

  <!-- Vault frame -->
  <div style="position:relative; display:inline-block; border:4px solid;
              border-image: linear-gradient(45deg, gold, orange, crimson) 1;
              border-radius:12px; padding:4px; animation: glow 2s infinite alternate;">
    <video id="video" width="320" height="240" autoplay muted playsinline 
           style="border-radius:8px; display:block;"></video>
    <canvas id="overlay" width="320" height="240" 
            style="position:absolute; top:0; left:0; border-radius:8px; pointer-events:none;"></canvas>
  </div>

  <!-- Status banner -->
  <div id="scanStatus" style="margin-top:12px; font-weight:bold; color:#2196F3;">
    Ready to Scan
  </div>

  <!-- Controls -->
  <div style="margin-top:15px;">
    <button onclick="startFaceScan()" style="background:#4CAF50;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;margin-right:10px;">
      Start Scan
    </button>
    <button onclick="stopFaceScan()" style="background:#f44336;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;">
      Stop Scan
    </button>
  </div>

  <!-- Gallery -->
  <h3 style="margin-top:20px; font-size:16px; color:#444;">üì∏ Captured Snapshots</h3>
  <div id="gallery" style="margin-top:10px; display:flex; gap:10px; overflow-x:auto; padding:5px; border:1px dashed #aaa; border-radius:8px;">
    <p id="noSnaps" style="color:#777; font-size:13px;">No snapshots yet</p>
  </div>

  <!-- Capture + Mint -->
  <div style="margin-top:15px;">
    <button onclick="captureSnapshot()" style="background:#2196F3;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;margin-right:10px;">
      Capture Snapshot
    </button>
    <button onclick="mintSnapshotNFT()" style="background:#673AB7;color:white;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;">
      Mint Selected Snapshot as NFT
    </button>
  </div>

  <!-- Minting Result -->
  <div id="mintResult" style="margin-top:20px; display:none; border:1px solid #ccc; border-radius:8px; padding:15px; text-align:left;">
    <h3 style="font-size:16px; margin-bottom:10px;">‚úÖ NFT Minted</h3>
    <img id="mintPreview" src="" alt="NFT Preview" style="width:100%; max-width:280px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
    <p><a id="txLink" href="#" target="_blank" style="color:#2196F3;">View Transaction</a></p>
    <p><a id="openseaLink" href="#" target="_blank" style="color:#673AB7;">View on OpenSea</a></p>
  </div>
</div>

<style>
@keyframes glow {
  from { box-shadow: 0 0 10px gold; }
  to { box-shadow: 0 0 20px orange; }
}
</style>

<!-- Face API + Ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<script>
const NFT_STORAGE_KEY = "e45adb75.7c576e66ce6d497d853b61f4645f9039"; 
const CONTRACT_ADDRESS = "0x8Cbe46A175E9CE3bB9FCF1F739F8C6b37d3308b3"; 

let scanInterval;
let streamRef;
let selectedSnapshot = null;

// Start Scan
async function startFaceScan() {
  const status = document.getElementById("scanStatus");
  status.innerText = "Loading models...";
  status.style.color = "#FF9800";




  const MODEL_URL = "https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights";
  

await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const context = overlay.getContext('2d');

  navigator.mediaDevices.getUserMedia({ video: {} })
    .then(stream => {
      streamRef = stream;
      video.srcObject = stream;
      status.innerText = "Scanning...";
      status.style.color = "#2196F3";
    })
    .catch(err => {
      status.innerText = "Camera access denied";
      status.style.color = "#f44336";
    });

  video.addEventListener('playing', () => {
    if (scanInterval) clearInterval(scanInterval);
    scanInterval = setInterval(async () => {
      const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks();
      context.clearRect(0, 0, overlay.width, overlay.height);

      if (detections.length > 0) {
        context.strokeStyle = "#4CAF50";
        context.lineWidth = 2;
        detections.forEach(det => {
          const box = det.detection.box;
          context.strokeRect(box.x, box.y, box.width, box.height);
        });
        status.innerText = "Face Detected!";
        status.style.color = "#4CAF50";
      } else {
        status.innerText = "No Face Found";
        status.style.color = "#f44336";
      }
    }, 200);
  });
}

// Stop Scan
function stopFaceScan() {
  if (scanInterval) clearInterval(scanInterval);
  if (streamRef) streamRef.getTracks().forEach(track => track.stop());
  document.getElementById("scanStatus").innerText = "Scan stopped";
  document.getElementById("scanStatus").style.color = "#999";
}

// Capture Snapshot
function captureSnapshot() {
  const video = document.getElementById('video');
  const canvas = document.createElement('canvas');
  canvas.width = 160;
  canvas.height = 120;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const gallery = document.getElementById("gallery");
  document.getElementById("noSnaps").style.display = "none";

  const img = document.createElement("img");
  img.src = canvas.toDataURL("image/png");
  img.style.width = "160px";
  img.style.border = "2px solid transparent";
  img.style.borderRadius = "6px";
  img.style.cursor = "pointer";
  img.onclick = () => {
    // Select snapshot
    Array.from(gallery.children).forEach(el => el.style.border="2px solid transparent");
    img.style.border="2px solid #2196F3";
    selectedSnapshot = img.src;
  };

  gallery.appendChild(img);

  if (!selectedSnapshot) selectedSnapshot = img.src;
}

// Mint NFT
async function mintSnapshotNFT() {
  if (!selectedSnapshot) {
    alert("Please capture and select a snapshot first!");
    return;
  }

  const blob = await (await fetch(selectedSnapshot)).blob();

  // Upload snapshot to IPFS
  const formData = new FormData();
  formData.append("file", blob, "snapshot.png");

  const uploadRes = await fetch("https://api.nft.storage/upload", {
    method: "POST",
    headers: { Authorization: `Bearer ${NFT_STORAGE_KEY}` },
    body: formData,
  });
  const uploadData = await uploadRes.json();
  const ipfsUrl = `ipfs://${uploadData.value.cid}`;

  // Metadata
  const metadata = {
    name: "Cultural Vault Snapshot",
    description: "Preserved cultural expression captured via Soul Internet Vault.",
    image: ipfsUrl,
  };

  const metaRes = await fetch("https://api.nft.storage/upload", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${NFT_STORAGE_KEY}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify(metadata),
  });
  const metaData = await metaRes.json();
  const tokenURI = `ipfs://${metaData.value.cid}`;

  if (!window.ethereum) {
    alert("MetaMask not detected!");
    return;
  }

  await window.ethereum.request({ method: "eth_requestAccounts" });
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  const signer = provider.getSigner();

  const abi = ["function mint(address to, string memory tokenURI) public returns (uint256)"];
  const contract = new ethers.Contract(CONTRACT_ADDRESS, abi, signer);
  const userAddress = await signer.getAddress();

  try {
    const tx = await contract.mint(userAddress, tokenURI);
    await tx.wait();

    document.getElementById("mintResult").style.display = "block";
    document.getElementById("mintPreview").src = selectedSnapshot;
    document.getElementById("txLink").href = `https://etherscan.io/tx/${tx.hash}`;
    document.getElementById("openseaLink").href = `https://opensea.io/assets/ethereum/${CONTRACT_ADDRESS}/`;
  } catch (err) {
    alert("‚ùå Error minting: " + err.message);
  }
}
</script>
    

    
    <!-- Facial Recognition -->

 
  
    
<!-- Facial Recognition -->

<!-- Facial Recognition -->
<div class="card" style="padding:20px; background:#1a1a1a; color:white; border-radius:12px; text-align:center; box-shadow:0 4px 8px rgba(0,0,0,0.5);">
  <h2 style="color:#4CAF50; margin-bottom:12px; font-weight:bold;">Facial Recognition</h2>

  <!-- Video Feed -->
  <video id="video" width="100%" height="240" autoplay muted playsinline
    style="border:2px solid #4CAF50; border-radius:10px; margin-bottom:12px;">
  </video>

  <!-- Canvas Overlay -->
  <canvas id="overlay" width="320" height="240"
    style="position:absolute; left:50%; transform:translateX(-50%); top:0; display:none;">
  </canvas>

  <!-- Status -->
  <p id="scan-status" style="font-size:14px; color:#ccc; margin:8px 0;">Press start to scan</p>

  <!-- Buttons -->
  <button onclick="startFace()" 
    style="background:#4CAF50; color:white; padding:10px 18px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin:5px;">
    ‚ñ∂ Start Scan
  </button>

  <button onclick="mintFaceNFT()" 
    style="background:#2196F3; color:white; padding:10px 18px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin:5px;">
    ü™ô Mint Face NFT
  </button>
</div>

<!-- Load Libraries -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

<!-- Facial Recognition Logic -->
<script>
window.onload = function() {
  const status = document.getElementById('scan-status');
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  let faceDetected = false;

  async function startFace() {
    try {
      status.innerText = "Loading models...";

      // GitHub weights
      const MODEL_URL = "https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights";

      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
      ]);

      status.innerText = "Models loaded ‚úÖ Starting camera...";

      const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
      video.srcObject = stream;

      video.onplaying = () => {
        overlay.style.display = "block";
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
        runDetection();
      };

    } catch (err) {
      status.innerText = "‚ö† Error: " + err;
    }
  }

  async function runDetection() {
    const displaySize = { width: video.videoWidth, height: video.videoHeight };
    faceapi.matchDimensions(overlay, displaySize);

    setInterval(async () => {
      const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors();

      const resized = faceapi.resizeResults(detections, displaySize);

      const context = overlay.getContext('2d');
      context.clearRect(0, 0, overlay.width, overlay.height);

      faceapi.draw.drawDetections(overlay, resized);
      faceapi.draw.drawFaceLandmarks(overlay, resized);

      if (detections.length > 0) {
        faceDetected = true;
        status.innerText = `Detected ${detections.length} face(s) üë§`;
      } else {
        faceDetected = false;
        status.innerText = "No face detected...";
      }
    }, 500);
  }

  // NFT Mint Function
  async function mintFaceNFT() {
    if (!faceDetected) {
      alert("‚ö† No face detected! Please scan first.");
      return;
    }

    if (typeof window.ethereum === "undefined") {
      alert("MetaMask not found. Please install MetaMask.");
      return;
    }

    try {
      await window.ethereum.request({ method: "eth_requestAccounts" });
      const web3 = new Web3(window.ethereum);

      const contractAddress = "0x4df55fad5af6ce9238d5d43f1589bc52cbea7b82"; // Your contract
      const abi = []; // TODO: paste your ABI JSON here
      const contract = new web3.eth.Contract(abi, contractAddress);

      const accounts = await web3.eth.getAccounts();
      const account = accounts[0];

      // Dummy IPFS metadata for now
      const tokenURI = "ipfs://your-face-scan-metadata";

      status.innerText = "Minting NFT... Please confirm in MetaMask";

      const tx = await contract.methods.mint(account, tokenURI).send({ from: account });

      status.innerText = "‚úÖ NFT Minted! Tx: " + tx.transactionHash;
    } catch (err) {
      status.innerText = "‚ö† Mint error: " + err.message;
    }
  }

  // Expose functions to buttons
  window.startFace = startFace;
  window.mintFaceNFT = mintFaceNFT;
};
</script>



    <!-- Steps Recording -->
    <div class="card">
      <h2>Steps Recording</h2>
      <button onclick="startVideoRecord()">Record Dance</button>
      <video id="danceVideo" controls></video>
    </div>

    <!-- Voice Recognition -->
    <div class="card">
      <h2>Voice Recording</h2>
      <button onclick="startAudio()">Record Voice</button>
      <audio id="audioPlay" controls></audio>
    </div>

    <!-- Document Upload -->
    <div class="card">
      <h2>Upload Document</h2>
      <input type="file" id="docUpload">
      <button onclick="uploadDoc()">Upload & Mint</button>
    </div>
  </div>

  <footer>
    Contributor: 0x8Cbe46A175E9CE3bB9FCF1F739F8C6b37d3308b3 ¬∑ Vault Contract: 0x4df55fad5af6ce9238d5d43f1589bc52cbea7b82
  </footer>

  <script type="module">
    import { NFTStorage, File } from "https://cdn.jsdelivr.net/npm/@nftstorage/nft-storage/dist/bundle.esm.min.js";
    
    const NFT_STORAGE_KEY = "e45adb75.7c576e66ce6d497d853b61f4645f9039";
    const CONTRACT_ADDRESS = "0x4df55fad5af6ce9238d5d43f1589bc52cbea7b82";
    const CONTRIBUTOR = "0x8Cbe46A175E9CE3bB9FCF1F739F8C6b37d3308b3";

    // === FACE RECOGNITION ===
    async function startFace() {
      await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
      const video = document.getElementById('video');
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => video.srcObject = stream);
      video.addEventListener('play', () => {
        const canvas = faceapi.createCanvasFromMedia(video);
        document.body.append(canvas);
        setInterval(async () => {
          const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
          canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
          faceapi.draw.drawDetections(canvas, detections);
        }, 200);
      });
    }

    // === VIDEO RECORD ===
    let vidRecorder, vidChunks = [];
    function startVideoRecord() {
      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        vidRecorder = new MediaRecorder(stream);
        vidRecorder.ondataavailable = e => vidChunks.push(e.data);
        vidRecorder.onstop = () => {
          const blob = new Blob(vidChunks, { type: 'video/mp4' });
          document.getElementById('danceVideo').src = URL.createObjectURL(blob);
          vidChunks = [];
        };
        vidRecorder.start();
        setTimeout(() => vidRecorder.stop(), 5000);
      });
    }

    // === AUDIO RECORD ===
    let audRecorder, audChunks = [];
    function startAudio() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        audRecorder = new MediaRecorder(stream);
        audRecorder.ondataavailable = e => audChunks.push(e.data);
        audRecorder.onstop = () => {
          const blob = new Blob(audChunks, { type: 'audio/mp3' });
          document.getElementById('audioPlay').src = URL.createObjectURL(blob);
          audChunks = [];
        };
        audRecorder.start();
        setTimeout(() => audRecorder.stop(), 4000);
      });
    }

    // === DOCUMENT UPLOAD + NFT ===
    async function uploadDoc() {
      const fileInput = document.getElementById('docUpload');
      if (!fileInput.files.length) return alert("Upload a file first!");
      const file = fileInput.files[0];

      const client = new NFTStorage({ token: NFT_STORAGE_KEY });
      const metadata = await client.store({
        name: file.name,
        description: "Cultural Document Upload",
        image: new File([file], file.name, { type: file.type })
      });

      alert("Uploaded to IPFS: " + metadata.url);
      await mintNFT(metadata.url);
    }

    async function mintNFT(tokenURI) {
      if (!window.ethereum) return alert("Please install MetaMask");
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();
      const abi = [
        "function safeMint(address to, string memory uri) public"
      ];
      const contract = new ethers.Contract(CONTRACT_ADDRESS, abi, signer);
      const tx = await contract.safeMint(CONTRIBUTOR, tokenURI);
      await tx.wait();
      alert("NFT Minted successfully!");
    }

    // expose funcs
    window.startFace = startFace;
    window.startVideoRecord = startVideoRecord;
    window.startAudio = startAudio;
    window.uploadDoc = uploadDoc;
  </script>
</body>
  </html>
  
