<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cultural Vault ‚Äî Steps Recording Layer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body { background:#041025; color:#f8fafc; font-family:sans-serif; }
    .capsule { background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06); border-radius:1rem; }
    .footprint {
      position:absolute;
      font-size:2rem;
      transform:translate(-50%,-50%);
      animation:footPulse 1.6s ease-out forwards;
      filter:drop-shadow(0 0 12px #7c3aed) drop-shadow(0 0 20px #06b6d4);
    }
    @keyframes footPulse {
      0% { transform:translate(-50%,-50%) scale(0.5); opacity:0.9; }
      70% { transform:translate(-50%,-50%) scale(1.2); opacity:0.6; }
      100% { transform:translate(-50%,-50%) scale(1.6); opacity:0; }
    }
    #traceCanvas { position:absolute; inset:0; pointer-events:none; }
    .intro-overlay {
      position:fixed; inset:0; background:#041025;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:50; color:#f1f5f9; text-align:center;
    }
    .intro-overlay h1 { font-size:2.5rem; color:#38bdf8; margin-bottom:1rem; }
    .intro-overlay p { color:#a5b4fc; font-size:1.2rem; margin-bottom:2rem; }
    .intro-overlay button {
      background:linear-gradient(90deg,#06b6d4,#3b82f6);
      color:white; padding:0.75rem 2rem; border-radius:9999px;
      font-weight:600; font-size:1.1rem;
      box-shadow:0 0 20px rgba(6,182,212,0.5), 0 0 30px rgba(59,130,246,0.3);
    }
    .gallery-card {
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.05);
      border-radius:0.75rem;
      padding:1rem;
      box-shadow:0 0 20px rgba(124,58,237,0.25);
    }
  </style>
</head>
<body class="p-6">

<!-- Intro Overlay -->
<div id="intro" class="intro-overlay">
  <h1>üë£ Step Into the Vault</h1>
  <p>Your footsteps will become memory traces, preserved for eternity.</p>
  <button onclick="startExperience()">Begin Ritual</button>
</div>

<main class="max-w-5xl mx-auto space-y-8">

  <!-- Recording Stage -->
  <section id="stage" class="capsule p-6 hidden">
    <h2 class="text-2xl font-bold text-cyan-300 mb-4">üé• Steps Recording Layer</h2>
    <div class="relative rounded-lg overflow-hidden" style="height:420px;">
      <video id="video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;"></video>
      <canvas id="traceCanvas"></canvas>
      <div id="stepsOverlay" class="absolute inset-0"></div>
    </div>
    <div class="mt-4 flex gap-3">
      <button id="stopBtn" class="px-4 py-2 rounded-lg bg-red-600 text-white" disabled>Stop & Save</button>
    </div>
  </section>

  <!-- Preview Capsule -->
  <section id="preview" class="capsule p-6 hidden">
    <h2 class="text-xl font-semibold">üßæ Step Capsule Preview</h2>
    <video id="previewVideo" controls class="mt-3 w-full rounded-lg"></video>

    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="text-sm text-slate-300">Dance / Ritual Type</label>
        <input id="metaType" class="w-full rounded p-2 text-black" placeholder="Eg: Kikuyu Dance"/>
      </div>
      <div>
        <label class="text-sm text-slate-300">Location</label>
        <input id="metaLocation" class="w-full rounded p-2 text-black" placeholder="Kenya, Nairobi"/>
      </div>
      <div>
        <label class="text-sm text-slate-300">Date</label>
        <input id="metaDate" type="date" class="w-full rounded p-2 text-black"/>
      </div>
      <div>
        <label class="text-sm text-slate-300">Description</label>
        <textarea id="metaDesc" class="w-full rounded p-2 text-black" rows="2"
          placeholder="Describe the meaning of this dance/steps..."></textarea>
      </div>
    </div>

    <div class="mt-4 flex gap-3 flex-wrap">
      <button id="downloadTrace" class="px-4 py-2 bg-cyan-600 rounded-lg">‚¨áÔ∏è Download Trace</button>
      <button id="downloadVideo" class="px-4 py-2 bg-indigo-600 rounded-lg">‚¨áÔ∏è Download Video</button>
      <button id="downloadMeta" class="px-4 py-2 bg-slate-600 rounded-lg">‚¨áÔ∏è Metadata JSON</button>
      <button id="mintBtn" class="px-4 py-2 bg-violet-600 rounded-lg">ü™ô Mint Step Capsule (demo)</button>
    </div>
  </section>

  <!-- Vault Gallery -->
  <section id="gallerySection" class="capsule p-6 hidden">
    <h2 class="text-2xl font-bold mb-4 text-indigo-300">üñº Vaulted Movements</h2>
    <div id="gallery" class="grid md:grid-cols-2 gap-4"></div>
  </section>

</main>

<script>
const intro=document.getElementById("intro"),stage=document.getElementById("stage"),
preview=document.getElementById("preview"),gallery=document.getElementById("gallery"),
gallerySection=document.getElementById("gallerySection");
const video=document.getElementById("video"),traceCanvas=document.getElementById("traceCanvas"),
ctx=traceCanvas.getContext("2d"),stepsOverlay=document.getElementById("stepsOverlay"),
stopBtn=document.getElementById("stopBtn"),previewVideo=document.getElementById("previewVideo");
const metaDate=document.getElementById("metaDate"),metaLocation=document.getElementById("metaLocation"),
metaType=document.getElementById("metaType"),metaDesc=document.getElementById("metaDesc");
let camera,stream,mediaRecorder,recordedChunks=[],pathPoints=[];

function startExperience(){
  intro.style.display="none"; stage.classList.remove("hidden"); initCamera();
}
async function initCamera(){
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:true});
  video.srcObject=stream;
  video.onloadedmetadata=()=>{ traceCanvas.width=video.videoWidth; traceCanvas.height=video.videoHeight; };
  recordedChunks=[]; mediaRecorder=new MediaRecorder(stream,{mimeType:"video/webm"});
  mediaRecorder.ondataavailable=e=>{ if(e.data.size) recordedChunks.push(e.data); };
  mediaRecorder.onstop=()=>{ const blob=new Blob(recordedChunks,{type:"video/webm"});
    previewVideo.src=URL.createObjectURL(blob); };
  mediaRecorder.start(); stopBtn.disabled=false;

  const pose=new Pose.Pose({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
  pose.setOptions({modelComplexity:0,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
  pose.onResults(onResults);
  camera=new Camera(video,{onFrame:async()=>{ await pose.send({image:video}); },width:640,height:480});
  camera.start();
}
function onResults(results){
  if(!results.poseLandmarks) return;
  const L=Pose.POSE_LANDMARKS.LEFT_FOOT_INDEX,R=Pose.POSE_LANDMARKS.RIGHT_FOOT_INDEX;
  [results.poseLandmarks[L],results.poseLandmarks[R]].forEach(foot=>{
    if(foot && foot.visibility>0.6){
      const x=foot.x*traceCanvas.width,y=foot.y*traceCanvas.height;
      pathPoints.push({x,y,time:Date.now()}); drawTrace();
      const span=document.createElement("span"); span.className="footprint"; span.textContent="üë£";
      span.style.left=(foot.x*100)+"%"; span.style.top=(foot.y*100)+"%"; stepsOverlay.appendChild(span);
      setTimeout(()=>span.remove(),1500);
    }
  });
}
function drawTrace(){
  ctx.fillStyle="rgba(4,16,32,0.15)"; ctx.fillRect(0,0,traceCanvas.width,traceCanvas.height);
  ctx.beginPath(); ctx.strokeStyle="rgba(124,58,237,0.9)"; ctx.lineWidth=3; ctx.shadowBlur=20; ctx.shadowColor="#06b6d4";
  pathPoints.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); }); ctx.stroke();
}
stopBtn.onclick=()=>{ camera.stop(); stream.getTracks().forEach(t=>t.stop()); mediaRecorder.stop();
  stage.classList.add("hidden"); preview.classList.remove("hidden"); metaDate.value=new Date().toISOString().slice(0,10); };

document.getElementById("downloadTrace").onclick=()=>{ const url=traceCanvas.toDataURL("image/png"); dl(url,"trace.png"); };
document.getElementById("downloadVideo").onclick=()=>{ const blob=new Blob(recordedChunks,{type:"video/webm"}); dl(URL.createObjectURL(blob),"steps.webm"); };
document.getElementById("downloadMeta").onclick=()=>{ const metadata=getMeta(); const blob=new Blob([JSON.stringify(metadata,null,2)],{type:"application/json"}); dl(URL.createObjectURL(blob),"metadata.json"); };

document.getElementById("mintBtn").onclick=()=>{
  const metadata=getMeta();
  const traceUrl=traceCanvas.toDataURL("image/png");
  const videoBlob=new Blob(recordedChunks,{type:"video/webm"}); const videoUrl=URL.createObjectURL(videoBlob);
  const card=document.createElement("div"); card.className="gallery-card";
  card.innerHTML=`
    <img src="${traceUrl}" class="w-full h-40 object-cover rounded mb-2"/>
    <h3 class="font-semibold">${metadata.type}</h3>
    <p class="text-sm text-slate-400">${metadata.location} ‚Ä¢ ${metadata.date}</p>
    <div class="mt-2 flex gap-2 flex-wrap text-sm">
      <a href="${traceUrl}" download="trace.png" class="underline">Trace</a>
      <a href="${videoUrl}" download="steps.webm" class="underline">Video</a>
      <a href="data:application/json,${encodeURIComponent(JSON.stringify(metadata))}" download="metadata.json" class="underline">Metadata</a>
    </div>
  `;
  gallery.prepend(card); gallerySection.classList.remove("hidden");
  alert("Demo: Step Capsule added to Vault Gallery");
};
function getMeta(){
  return {
    type:metaType.value||"Unknown Dance",
    location:metaLocation.value||"Unknown",
    date:metaDate.value,
    description:metaDesc.value||"Steps preserved in vault",
    points:pathPoints.length
  };
}
function dl(url,name){ const a=document.createElement("a"); a.href=url;a.download=name;a.click(); }
</script>
</body>
</html>
